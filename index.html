<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Score Table</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  #header {
    background: #f4f4f4;
    padding: 10px;
  }
  table {
    width: 90%;
    margin: auto;
    border-collapse: collapse;
    table-layout: fixed;
  }
  th, td {
    border: 1px solid black;
    padding: 5px;
    text-align: center;
  }
  input[type="text"], input[type="number"] {
    width: 20%;
    text-align: center;
  }
  .total-positive { color: green; font-weight: bold; }
  .total-negative { color: red; font-weight: bold; }
  .total-neutral { color: gray; font-weight: bold; }

  #scoreTable {
    max-height: 400px;
    overflow-y: auto;
    display: block;
  }
  #scoreTable thead {
    position: sticky;
    top: 0;
    background: white;
    z-index: 2;
  }
  #scoreTable thead th {
    position: sticky;
    top: 0;
    background: white;
    z-index: 3;
  }
  /* Total row (2nd header row) sticky under the first header row */
  #scoreTable thead tr:nth-child(2) th {
    top: 23px; /* keep your current visual */
    background: #f9f9f9;
    z-index: 2;
  }
</style>
</head>
<body>

<div id="header">
  <h2>Đánh Bài Thoai</h2>
  <button onclick="enterPoints()">Enter Points</button>
  <button onclick="completeScores()">Complete</button>
  <button onclick="resetAll()">Reset</button>
</div>

<table id="scoreTable">
  <thead>
    <tr>
      <th>Check</th>
      <th><input type="text" id="name-0" placeholder="Name" onblur="setName(0)"></th>
      <th><input type="text" id="name-1" placeholder="Name" onblur="setName(1)"></th>
      <th><input type="text" id="name-2" placeholder="Name" onblur="setName(2)"></th>
      <th><input type="text" id="name-3" placeholder="Name" onblur="setName(3)"></th>
    </tr>
    <tr>
      <th>Total</th>
      <th id="total-score-0" class="total-neutral">0</th>
      <th id="total-score-1" class="total-neutral">0</th>
      <th id="total-score-2" class="total-neutral">0</th>
      <th id="total-score-3" class="total-neutral">0</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const STORAGE_KEY = "score_table_v1";

  function safeParseInt(v) {
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : 0;
  }

  function getNameState(i) {
    const th = document.querySelectorAll("#scoreTable thead tr:first-child th")[i + 1]; // +1 to skip "Check"
    const input = th.querySelector("input");
    if (input) {
      return { value: input.value || "", locked: false };
    }
    return { value: (th.textContent || "").trim(), locked: true };
  }

  function setNameState(i, state) {
    const th = document.querySelectorAll("#scoreTable thead tr:first-child th")[i + 1];
    th.innerHTML = ""; // clear
    if (state && state.locked) {
      // LOCKED: show plain text only (blur-lock behavior)
      th.textContent = state.value || "";
    } else {
      // UNLOCKED: show input
      const inp = document.createElement("input");
      inp.type = "text";
      inp.id = "name-" + i;
      inp.placeholder = "Name";
      inp.value = (state && state.value) ? state.value : "";
      inp.onblur = () => setName(i);
      th.appendChild(inp);
    }
  }

  function saveState() {
    const tbody = document.querySelector("#scoreTable tbody");
    const rows = Array.from(tbody.rows).map(tr => {
      const vals = [];
      for (let c = 1; c <= 4; c++) { // 1..4 are player cells, 0 is check
        const input = tr.cells[c].querySelector("input");
        vals.push(input ? (input.value || "") : "");
      }
      return vals;
    });

    const names = [0,1,2,3].map(i => getNameState(i));

    const state = { names, rows };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadState() {
    let raw = null;
    try {
      raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const state = JSON.parse(raw);

      // names
      if (state.names && Array.isArray(state.names)) {
        for (let i = 0; i < 4; i++) setNameState(i, state.names[i] || {value:"", locked:false});
      }

      // rows
      if (state.rows && Array.isArray(state.rows)) {
        const tbody = document.querySelector("#scoreTable tbody");
        tbody.innerHTML = "";
        state.rows.forEach(r => createRow(r));
      }

      // update totals + checks without alert
      computeTotalsAndChecks(false);
    } catch (e) {
      // if corrupt, ignore
      console.warn("Failed to load state:", e);
    }
  }

  function attachAutoSave(inputEl) {
    inputEl.addEventListener("input", () => {
      saveState();
      // optional: keep totals live
      computeTotalsAndChecks(false);
    });
  }

  function setName(index) {
    const input = document.getElementById("name-" + index);
    if (!input) return;
    const name = (input.value || "").trim();

    const th = input.parentElement;

    // LOCK name on blur (your current behavior), but safer than innerHTML
    th.textContent = name;

    saveState();
  }

  function createRow(presetValues) {
    const tbody = document.querySelector("#scoreTable tbody");
    const row = tbody.insertRow(-1);

    // Check column
    row.insertCell(0).innerHTML = "";

    for (let i = 0; i < 4; i++) {
      const cell = row.insertCell(i + 1);
      const input = document.createElement("input");
      input.type = "number";
      input.className = "score-input-" + i;
      input.value = (presetValues && presetValues[i] !== undefined) ? presetValues[i] : "";
      cell.appendChild(input);
      attachAutoSave(input);
    }

    saveState();
  }

  function enterPoints() {
    createRow();
  }

  function computeTotalsAndChecks(showAlert) {
    // totals
    for (let i = 0; i < 4; i++) {
      let total = 0;
      document.querySelectorAll(".score-input-" + i).forEach(input => {
        total += safeParseInt(input.value);
      });

      const totalCell = document.getElementById("total-score-" + i);
      totalCell.textContent = total;

      totalCell.className =
        total > 0 ? "total-positive" :
        total < 0 ? "total-negative" :
        "total-neutral";
    }

    // row checks
    const table = document.getElementById("scoreTable");
    let error = false;

    // easier: iterate tbody rows
    const tbody = table.querySelector("tbody");
    Array.from(tbody.rows).forEach(row => {
      let sum = 0;
      for (let colIdx = 1; colIdx <= 4; colIdx++) {
        const input = row.cells[colIdx].querySelector("input");
        sum += safeParseInt(input ? input.value : 0);
      }

      const checkCell = row.cells[0];
      if (sum === 0) {
        checkCell.innerHTML = "<span style='color: green; font-weight: bold;'>O</span>";
      } else {
        checkCell.innerHTML = "<span style='color: red; font-weight: bold;'>X</span>";
        error = true;
      }
    });

    if (showAlert && error) {
      alert("Nhập sai rồi bạn êyyyy ^_^");
    }
  }

  function completeScores() {
    computeTotalsAndChecks(true);
    saveState();
  }

  function resetAll() {
    if (!confirm("Reset toàn bộ dữ liệu?")) return;

    localStorage.removeItem(STORAGE_KEY);

    // reset names (back to inputs)
    for (let i = 0; i < 4; i++) setNameState(i, { value: "", locked: false });

    // clear rows
    document.querySelector("#scoreTable tbody").innerHTML = "";

    // reset totals
    for (let i = 0; i < 4; i++) {
      const totalCell = document.getElementById("total-score-" + i);
      totalCell.textContent = "0";
      totalCell.className = "total-neutral";
    }
  }

  // Load saved data on startup
  window.addEventListener("DOMContentLoaded", () => {
    loadState();
  });
</script>

</body>
</html>

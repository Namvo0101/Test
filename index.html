<!-- index.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Đánh bài cùng Bích Ngân ^_^</title>
  <style>
    :root { --thead-row-1-height: 0px; }

    body {
      text-align: center;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #header {
      font-size: 12px;
      margin: 8px 0;
      opacity: 0.8;
    }

    table {
      margin: 0 auto;
      border: 1px solid black;
      border-collapse: collapse;
      width: min(980px, 96vw);
      table-layout: fixed;
    }

    th, td {
      padding: 6px;
      text-align: center;
      box-sizing: border-box;
      word-wrap: break-word;
      border: 1px solid #000;
    }

    thead th { background-color: #f2f2f2; }

    .name-input {
      width: 100%;
      max-width: 220px;
      box-sizing: border-box;
      text-align: center;
      font-size: 16px;
      padding: 6px 8px;
    }

    .score-input {
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      font-size: 18px;
      padding: 8px 6px;
    }

    .score-positive { color: green; }
    .score-negative { color: red; }
    .score-neutral { color: grey; }

    .check-positive { color: green; font-weight: 700; }
    .check-negative { color: red; font-weight: 700; }

    .total-score {
      font-size: 26px;
      font-weight: 800;
    }

    .btns {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      padding: 12px 10px 18px;
    }

    button {
      font-size: 22px;
      padding: 10px 16px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .total-score { font-size: 20px; }
      button { font-size: 20px; padding: 10px 14px; }
      th, td { padding: 4px; }
      .score-input { font-size: 16px; padding: 8px 4px; }
      .name-input { font-size: 14px; }
    }

    /* Sticky header + total row (offset set by JS) */
    #scoreTable thead tr:first-child th {
      position: sticky;
      top: 0;
      z-index: 20;
    }

    #scoreTable thead tr:nth-child(2) td {
      position: sticky;
      top: var(--thead-row-1-height);
      z-index: 15;
      background: #fff;
    }

    #scoreTable col.check-col { width: 44px; }

    /* Optional UX */
    #nameRow th[role="button"] { cursor: pointer; }
  </style>
</head>

<body>
  <div id="header">------ Nam Vo ------</div>

  <table id="scoreTable">
    <colgroup>
      <col class="check-col" />
      <col /><col /><col /><col />
    </colgroup>

    <thead>
      <tr id="nameRow">
        <th></th>
        <th><input class="name-input" type="text" id="name-0" value="Bích Ngân" onblur="setName(0)"></th>
        <th><input class="name-input" type="text" id="name-1" value="Phương Nam" onblur="setName(1)"></th>
        <th><input class="name-input" type="text" id="name-2" value="Cẩm Lệ" onblur="setName(2)"></th>
        <th><input class="name-input" type="text" id="name-3" value="Nhật Nam" onblur="setName(3)"></th>
      </tr>
      <tr>
        <td></td>
        <td><span id="total-score-0" class="score-neutral total-score">0</span></td>
        <td><span id="total-score-1" class="score-neutral total-score">0</span></td>
        <td><span id="total-score-2" class="score-neutral total-score">0</span></td>
        <td><span id="total-score-3" class="score-neutral total-score">0</span></td>
      </tr>
    </thead>

    <tbody id="scoreBody"></tbody>
  </table>

  <div class="btns">
    <button id="btnAdd" type="button">Enter Points</button>
    <button id="btnComplete" type="button">Complete</button>
    <button id="btnReset" type="button">Reset</button>
  </div>

  <script>
    const STORAGE_KEY = "scoreTableState_v3";
    const DEFAULT_NAMES = ["Bích Ngân", "Phương Nam", "Cẩm Lệ", "Nhật Nam"];

    const table = document.getElementById("scoreTable");
    const tbody = document.getElementById("scoreBody");
    const totalEls = [0, 1, 2, 3].map((i) => document.getElementById(`total-score-${i}`));

    function toInt(v) {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 0;
    }

    function setTotalStyle(el, v) {
      if (v > 0) el.className = "score-positive total-score";
      else if (v < 0) el.className = "score-negative total-score";
      else el.className = "score-neutral total-score";
    }

    function getNameTh(index) {
      return document.querySelector(`#nameRow th:nth-child(${index + 2})`);
    }

    function getNamesAndLocked() {
      const names = [];
      const locked = [];
      for (let i = 0; i < 4; i++) {
        const th = getNameTh(i);
        const inp = th.querySelector("input");
        if (inp) {
          names.push(inp.value ?? "");
          locked.push(false);
        } else {
          names.push(th.textContent ?? "");
          locked.push(true);
        }
      }
      return { names, locked };
    }

    function readRows() {
      const rows = [];
      for (const tr of tbody.querySelectorAll("tr")) {
        const inputs = tr.querySelectorAll("input.score-input");
        rows.push(Array.from(inputs).map((inp) => toInt(inp.value)));
      }
      return rows;
    }

    function saveState() {
      const { names, locked } = getNamesAndLocked();
      const rows = readRows();
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ names, locked, rows }));
    }

    function renderNameCell(index, name, isLocked) {
      const th = getNameTh(index);
      th.innerHTML = "";
      th.ondblclick = null;
      th.title = "";
      th.removeAttribute("role");

      if (isLocked) {
        th.textContent = String(name ?? "");
        th.title = "Double-click để sửa tên";
        th.setAttribute("role", "button");
        th.ondblclick = () => window.unlockName(index);
        return;
      }

      const inp = document.createElement("input");
      inp.className = "name-input";
      inp.type = "text";
      inp.id = `name-${index}`;
      inp.value = String(name ?? "");
      inp.setAttribute("onblur", `setName(${index})`);
      inp.addEventListener("input", saveState);
      th.appendChild(inp);
    }

    function writeRows(rows) {
      tbody.innerHTML = "";
      for (const r of rows) addRow(r);
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;

      try {
        const state = JSON.parse(raw);
        const names = Array.isArray(state?.names) && state.names.length === 4 ? state.names : null;
        const locked = Array.isArray(state?.locked) && state.locked.length === 4 ? state.locked : [false, false, false, false];

        if (names) {
          for (let i = 0; i < 4; i++) renderNameCell(i, names[i], Boolean(locked[i]));
        }

        if (Array.isArray(state?.rows)) writeRows(state.rows);
      } catch (_) {
        localStorage.removeItem(STORAGE_KEY);
      }
    }

    function recalc({ alertOnError } = { alertOnError: false }) {
      const totals = [0, 0, 0, 0];
      let hasError = false;

      const trs = Array.from(tbody.querySelectorAll("tr"));
      for (const tr of trs) {
        const values = Array.from(tr.querySelectorAll("input.score-input")).map((inp) => toInt(inp.value));
        for (let i = 0; i < 4; i++) totals[i] += values[i];

        const rowSum = values.reduce((a, b) => a + b, 0);
        const checkCell = tr.querySelector("td[data-check]");
        if (rowSum === 0) {
          checkCell.innerHTML = '<span class="check-positive">O</span>';
        } else {
          checkCell.innerHTML = '<span class="check-negative">X</span>';
          hasError = true;
        }
      }

      for (let i = 0; i < 4; i++) {
        totalEls[i].innerText = String(totals[i]);
        setTotalStyle(totalEls[i], totals[i]);
      }

      saveState();

      if (alertOnError && hasError) {
        alert("Nhập sai rồi bạn êyyyy ^_^ (Có dòng tổng không bằng 0)");
      }
    }

    function focusFirstInput(tr) {
      const first = tr.querySelector("input.score-input");
      if (first) first.focus();
    }

    function addRow(initialValues = [0, 0, 0, 0]) {
      const tr = document.createElement("tr");

      const checkTd = document.createElement("td");
      checkTd.setAttribute("data-check", "1");
      tr.appendChild(checkTd);

      for (let i = 0; i < 4; i++) {
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.type = "number";
        inp.className = "score-input";
        inp.inputMode = "numeric";
        inp.value = String(toInt(initialValues[i] ?? 0));

        inp.addEventListener("input", () => recalc({ alertOnError: false }));

        inp.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;

          const inputs = Array.from(tr.querySelectorAll("input.score-input"));
          const idx = inputs.indexOf(inp);

          if (idx >= 0 && idx < inputs.length - 1) {
            e.preventDefault();
            inputs[idx + 1].focus();
            return;
          }

          e.preventDefault();
          const newTr = addRow([0, 0, 0, 0]);
          focusFirstInput(newTr);
          recalc({ alertOnError: false });
        });

        td.appendChild(inp);
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
      return tr;
    }

    function updateStickyOffsets() {
      const row1 = table.querySelector("thead tr:first-child");
      const h = row1 ? row1.getBoundingClientRect().height : 0;
      table.style.setProperty("--thead-row-1-height", `${Math.ceil(h)}px`);
    }

    function resetAll() {
      tbody.innerHTML = "";

      for (let i = 0; i < 4; i++) renderNameCell(i, DEFAULT_NAMES[i], false);

      for (let i = 0; i < 4; i++) {
        totalEls[i].innerText = "0";
        totalEls[i].className = "score-neutral total-score";
      }

      localStorage.removeItem(STORAGE_KEY);

      addRow([0, 0, 0, 0]);
      updateStickyOffsets();
      recalc({ alertOnError: false });
    }

    // blur -> lock
    window.setName = function setName(index) {
      const input = document.getElementById(`name-${index}`);
      if (!input) return;

      const name = input.value ?? "";
      const th = input.parentElement;

      th.innerHTML = "";
      th.textContent = name;
      th.title = "Double-click để sửa tên";
      th.setAttribute("role", "button");
      th.ondblclick = () => window.unlockName(index);

      saveState();
      updateStickyOffsets();
    };

    // double-click -> unlock (edit)
    window.unlockName = function unlockName(index) {
      const th = getNameTh(index);
      const currentName = (th.textContent ?? "").trim();

      renderNameCell(index, currentName, false);

      const input = document.getElementById(`name-${index}`);
      if (input) {
        input.focus();
        input.select();
      }

      saveState();
      updateStickyOffsets();
    };

    document.getElementById("btnAdd").addEventListener("click", () => {
      const tr = addRow([0, 0, 0, 0]);
      focusFirstInput(tr);
      recalc({ alertOnError: false });
    });

    document.getElementById("btnComplete").addEventListener("click", () => {
      recalc({ alertOnError: true });
    });

    document.getElementById("btnReset").addEventListener("click", resetAll);

    window.addEventListener("resize", updateStickyOffsets);

    loadState();
    if (tbody.children.length === 0) addRow([0, 0, 0, 0]);
    updateStickyOffsets();
    recalc({ alertOnError: false });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Score Table</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    #header {
      background: #f4f4f4;
      padding: 10px;
    }
    table {
      width: 90%;
      margin: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid black;
      padding: 5px;
      text-align: center;
    }
    input[type="text"], input[type="number"] {
      width: 20%;
      text-align: center;
    }
    .total-positive { color: green; font-weight: bold; }
    .total-negative { color: red; font-weight: bold; }
    .total-neutral { color: gray; font-weight: bold; }

    #scoreTable {
      max-height: 400px;
      overflow-y: auto;
      display: block;
    }
    #scoreTable thead {
      position: sticky;
      top: 0;
      background: white;
      z-index: 2;
    }
    #scoreTable thead th {
      position: sticky;
      top: 0;
      background: white;
      z-index: 3;
    }
    #scoreTable thead tr:nth-child(2) th {
      top: 23px;
      background: #f9f9f9;
      z-index: 2;
    }
  </style>
</head>
<body>

  <div id="header">
    <h2>Đánh Bài Thoai</h2>
    <button onclick="enterPoints()">Enter Points</button>
    <button onclick="completeScores()">Complete</button>
    <button onclick="resetGame()">Reset</button>
  </div>

  <table id="scoreTable">
    <thead>
      <tr>
        <th>Check</th>
        <th><input type="text" id="name-0" placeholder="Name" onblur="setName(0)"></th>
        <th><input type="text" id="name-1" placeholder="Name" onblur="setName(1)"></th>
        <th><input type="text" id="name-2" placeholder="Name" onblur="setName(2)"></th>
        <th><input type="text" id="name-3" placeholder="Name" onblur="setName(3)"></th>
      </tr>
      <tr>
        <th>Total</th>
        <th id="total-score-0" class="total-neutral">0</th>
        <th id="total-score-1" class="total-neutral">0</th>
        <th id="total-score-2" class="total-neutral">0</th>
        <th id="total-score-3" class="total-neutral">0</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be added here -->
    </tbody>
  </table>

  <script>
    // ===== Local Storage =====
    const STORAGE_KEY = "score_table_v1";

    function safeParseInt(v) {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : 0;
    }

    function makeNameInput(i, value = "") {
      const input = document.createElement("input");
      input.type = "text";
      input.id = "name-" + i;
      input.placeholder = "Name";
      input.value = value;
      input.onblur = () => setName(i);
      // autosave while typing name (before blur lock)
      input.addEventListener("input", () => saveState());
      return input;
    }

    function getNameState(i) {
      const th = document.querySelectorAll("#scoreTable thead tr:first-child th")[i + 1]; // skip "Check"
      const input = th.querySelector("input");
      if (input) {
        return { value: input.value || "", locked: false };
      }
      return { value: (th.textContent || "").trim(), locked: true };
    }

    function setNameState(i, state) {
      const th = document.querySelectorAll("#scoreTable thead tr:first-child th")[i + 1]; // skip "Check"
      th.innerHTML = "";
      if (state && state.locked) {
        th.textContent = state.value || "";
      } else {
        th.appendChild(makeNameInput(i, (state && state.value) ? state.value : ""));
      }
    }

    function saveState() {
      const tbody = document.querySelector("#scoreTable tbody");
      const rows = Array.from(tbody.rows).map(tr => {
        const vals = [];
        for (let c = 1; c <= 4; c++) { // 1..4 are players (0 is check)
          const input = tr.cells[c].querySelector("input");
          vals.push(input ? (input.value || "") : "");
        }
        return vals;
      });

      const names = [0,1,2,3].map(i => getNameState(i));

      const state = { names, rows };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        const state = JSON.parse(raw);

        // Restore names
        if (state.names && Array.isArray(state.names)) {
          for (let i = 0; i < 4; i++) {
            setNameState(i, state.names[i] || { value: "", locked: false });
          }
        }

        // Restore rows
        const tbody = document.querySelector("#scoreTable tbody");
        tbody.innerHTML = "";
        if (state.rows && Array.isArray(state.rows)) {
          state.rows.forEach(r => createRow(r));
        }

        // Recompute totals & checks, but NO alert on load
        computeTotalsAndChecks(false);
      } catch (e) {
        console.warn("Failed to load saved data:", e);
      }
    }

    // ===== Original behaviors (with storage hooks) =====
    function setName(index) {
      const input = document.getElementById("name-" + index);
      if (!input) return;

      const name = input.value;
      const th = input.parentElement;

      // blur-lock name like old behavior (but safer than innerHTML)
      th.textContent = name;

      saveState();
    }

    function attachAutoSaveScoreInput(inputEl) {
      inputEl.addEventListener("input", () => {
        saveState();
        // keep totals/checks live (no alert)
        computeTotalsAndChecks(false);
      });
    }

    function createRow(presetValues) {
      const tbody = document.querySelector("#scoreTable tbody");
      const row = tbody.insertRow(-1);

      // Check column
      row.insertCell(0).innerHTML = "";

      // 4 players columns
      for (let i = 0; i < 4; i++) {
        const cell = row.insertCell(i + 1);
        const input = document.createElement("input");
        input.type = "number";
        input.className = "score-input-" + i;
        input.value = (presetValues && presetValues[i] !== undefined) ? presetValues[i] : "";
        cell.appendChild(input);
        attachAutoSaveScoreInput(input);
      }

      saveState();
    }

    function enterPoints() {
      createRow();
    }

    function computeTotalsAndChecks(showAlert) {
      // Update totals
      for (let i = 0; i < 4; i++) {
        let total = 0;
        document.querySelectorAll(".score-input-" + i).forEach(input => {
          total += safeParseInt(input.value);
        });

        const totalCell = document.getElementById("total-score-" + i);
        totalCell.textContent = total;

        totalCell.className =
          total > 0 ? "total-positive" :
          total < 0 ? "total-negative" :
          "total-neutral";
      }

      // Check row sums (use tbody rows, same result but safer)
      const tbody = document.querySelector("#scoreTable tbody");
      let error = false;

      Array.from(tbody.rows).forEach(row => {
        let sum = 0;
        for (let colIdx = 1; colIdx <= 4; colIdx++) {
          const input = row.cells[colIdx].querySelector("input");
          sum += safeParseInt(input ? input.value : 0);
        }

        const checkCell = row.cells[0];
        if (sum === 0) {
          checkCell.innerHTML = "<span style='color: green; font-weight: bold;'>O</span>";
        } else {
          checkCell.innerHTML = "<span style='color: red; font-weight: bold;'>X</span>";
          error = true;
        }
      });

      if (showAlert && error) {
        alert("Nhập sai rồi bạn êyyyy ^_^");
      }
    }

    function completeScores() {
      computeTotalsAndChecks(true);
      saveState();
    }

    // ===== Reset for new game =====
    function resetGame() {
      if (!confirm("Xoá toàn bộ dữ liệu để bắt đầu ván mới?")) return;

      // Clear local storage
      localStorage.removeItem(STORAGE_KEY);

      // Reset names back to inputs
      for (let i = 0; i < 4; i++) {
        setNameState(i, { value: "", locked: false });
      }

      // Clear all score rows
      document.querySelector("#scoreTable tbody").innerHTML = "";

      // Reset totals
      for (let i = 0; i < 4; i++) {
        const totalCell = document.getElementById("total-score-" + i);
        totalCell.textContent = "0";
        totalCell.className = "total-neutral";
      }
    }

    // ===== Startup =====
    window.addEventListener("DOMContentLoaded", () => {
      loadState();
    });
  </script>

</body>
</html>
